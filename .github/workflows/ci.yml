name: CI/CD Quality Gate

on:
  push:
    branches:
      - main
      - 'ENG-*'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quality-check:
    name: Quality & Coverage Analysis
    runs-on: ubuntu-latest

    steps:
      - name: 拘勇 Checkout do C칩digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: 游릭 Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # --- TESTES DE REGRA DE NEG칍CIO (APP 1) ---
      - name: 游빍 Executar Testes (01-Sorteador)
        run: |
          if [ -d "01-Sorteador" ]; then
             echo "游꿣 Testando Regras de Neg칩cio do App 01-Sorteador..."
             cd 01-Sorteador
             npm install --ignore-scripts
             npm test -- --coverage
          elif [ -d "00-SmokeTeste" ]; then
             echo "游릭 Testando Regras de Neg칩cio do App 00-SmokeTeste..."
             cd 00-SmokeTeste
             npm install --ignore-scripts
             npm test -- --coverage
          else
             echo "丘멆잺 Pasta do App 1 n칚o encontrada. Pulando testes."
          fi

      # --- SONAR CLOUD (CONFIGURA칂츾O BLINDADA) ---
      - name: 游니 SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=tinalmeid_react-android-moderno
            -Dsonar.organization=tinalmeid
            -Dsonar.sources=.
            -Dsonar.javascript.lcov.reportPaths=**/coverage/lcov.info
            -Dsonar.exclusions=**/node_modules/**,**/02-AppNoticias/**,**/03-AppNetflix/**,**/*.test.js,**/coverage/**,**/.expo/**,**/*.config.js
