name: CI/CD Quality Gate

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quality-check:
    name: Quality & Coverage Analysis
    runs-on: ubuntu-latest

    steps:
      - name: 拘勇 Checkout do C칩digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Importante para o SonarCloud analisar o hist칩rico git

      - name: 游릭 Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18


      # Estrat칠gia Monorepo (pois ser칚o v치rios apps no mesmo reposit칩rio):

      - name: 游빍 Executar Testes e Verificar Cobertura (Local Gate)
        run: |
          # Procura todos os package.json (exceto node_modules) para identificar Apps
          APPS=$(find . -name "package.json" -not -path "*/node_modules/*" -not -path "./package.json")

          if [ -z "$APPS" ]; then
            echo "丘멆잺 Nenhum aplicativo encontrado para testar ainda. (Normal para setup inicial)"
          else
            for app_config in $APPS; do
              app_dir=$(dirname "$app_config")
              echo "游 Testando App na pasta: $app_dir"

              cd $app_dir
              npm install --ignore-scripts

              # Garantir que o Jest est치 execut치vel
              chmod +x node_modules/.bin/jest

              # AQUI EST츼 O SEU REQUISITO DE M칈NIMO80%
              # O Jest vai falhar se a cobertura global for menor que 80%
              npx jest --coverage --coverageThreshold='{"global":{"branches":80,"functions":80,"lines":80,"statements":80}}'

              cd - > /dev/null
            done
          fi

      - name: 游니 SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@ffc3010689be73b8e5ae0c57ce35968afd7909e8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Gerado automaticamente pelo Git
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}    # Voc칡 precisa adicionar isso nos Secrets do Repo
