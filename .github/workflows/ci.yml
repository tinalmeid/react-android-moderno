name: CI/CD Quality Gate

on:
  push:
    branches:
      - main
      - 'ENG-*'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quality-check:
    name: Quality & Coverage Analysis
    runs-on: ubuntu-latest

    steps:
      - name: 猬锔 Checkout do C贸digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name:  Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # --- TESTES DE REGRA DE NEGCIO (APP 1) ---
      - name: И Executar Testes (01-Sorteador)
        run: |
          # 1. Smoke Teste (Se existir)
          if [ -d "00-SmokeTeste" ]; then
             echo " Testando Regras de Neg贸cio do App 00-SmokeTeste..."
             cd 00-SmokeTeste
             npm install --ignore-scripts
             npm test -- --coverage
             cd .. # IMPORTANTE: Voltar para a raiz
          fi

          # 2. App 01 - Sorteador
          if [ -d "01-Sorteador" ]; then
             echo " Testando Regras de Neg贸cio do App 01-Sorteador..."
             cd 01-Sorteador
             npm install --ignore-scripts
             npm test -- --coverage
             cd ..
          fi

          # 3. App 04 - Frases (Com corre莽茫o do React 19)
          if [ -d "04-AppFrases" ]; then
             echo " Testando Regras de Neg贸cio do App 04-AppFrases..."
             cd 04-AppFrases
             npm install --legacy-peer-deps --ignore-scripts
             npm test -- --coverage
             cd ..
          else
             echo "锔 Pasta 04-AppFrases n茫o encontrada (verifique o nome)."
          fi

      # --- SONAR CLOUD (CONFIGURAO BLINDADA) ---
      - name:  SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=tinalmeid_react-android-moderno
            -Dsonar.organization=tinalmeid
            -Dsonar.sources=.
            -Dsonar.javascript.lcov.reportPaths=**/coverage/lcov.info
            -Dsonar.exclusions=**/node_modules/**,**/02-AppNoticias/**,**/03-AppNetflix/**,**/*.test.js,**/coverage/**,**/.expo/**,**/*.config.js
