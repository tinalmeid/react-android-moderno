name: CI/CD Quality Gate

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quality-check:
    name: Quality & Coverage Analysis
    runs-on: ubuntu-latest

    steps:
      - name: 拘勇 Checkout do C칩digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Importante para o SonarCloud analisar o hist칩rico git

      - name: 游릭 Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18


      # Estrat칠gia Monorepo (pois ser칚o v치rios apps no mesmo reposit칩rio):
      - name: 游빍 Executar Testes e Verificar Cobertura (Local Gate)
        run: |
          # Verifica se a pasta existe antes de tentar entrar
          if [ -d "00-SmokeTeste" ]; then
             echo "游릭 Testando Regras de Neg칩cio do App 0..."
             cd 00-SmokeTeste
             npm install
             npm test -- --coverage
          elif [ -d "01-Sorteador" ]; then
             echo "游꿣 Testando Regras de Neg칩cio do App 1..."
             cd 01-Sorteador
             npm install
             npm test -- --coverage
          else
             echo "丘멆잺 Pasta do App 1 n칚o encontrada com nome padr칚o. Pulando testes."
          fi

      - name: 游니 SonarCloud Scan
        # Atualizado para v4
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}


