name: CI/CD Quality Gate

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quality-check:
    name: Quality & Coverage Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout do C√≥digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Importante para o SonarCloud analisar o hist√≥rico git

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18


      # Estrat√©gia Monorepo (pois ser√£o v√°rios apps no mesmo reposit√≥rio):

      - name: üß™ Executar Testes e Verificar Cobertura (Local Gate)
        run: |
          # Procura todos os package.json (exceto node_modules) para identificar Apps
          APPS=$(find . -name "package.json" -not -path "*/node_modules/*" -not -path "./package.json")

          if [ -z "$APPS" ]; then
            echo "‚ö†Ô∏è Nenhum aplicativo encontrado para testar ainda. (Normal para setup inicial)"
          else
            for app_config in $APPS; do
              app_dir=$(dirname "$app_config")
              echo "üöÄ Testando App na pasta: $app_dir"

              cd $app_dir
              npm install --ignore-scripts

              # Garantir que o Jest est√° execut√°vel
              chmod +x node_modules/.bin/jest

              # AQUI EST√Å O SEU REQUISITO DE M√çNIMO80%
              # O Jest vai falhar se a cobertura global for menor que 80%
              npx jest --coverage --coverageThreshold='{"global":{"branches":80,"functions":80,"lines":80,"statements":80}}'

              cd - > /dev/null
            done
          fi

      - name: üì° SonarCloud Scan
        # FIX: Atualizado para v4 (remove o aviso de 'deprecated')
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          # Configura√ß√µes aqui ("Hardcoded") para garantir que funcione
          args: >
            -Dsonar.projectKey=tinalmeid_react-android-moderno
            -Dsonar.organization=tinalmeid
            -Dsonar.sources=.
            -Dsonar.tests=.
            -Dsonar.test.inclusions=**/*.test.js
            -Dsonar.javascript.lcov.reportPaths=**/coverage/lcov.info

            # Exclus√µes Gerais (Ignora o arquivo todo)
            -Dsonar.exclusions=**/node_modules/**,**/android/**,**/ios/**,**/.expo/**,**/web-build/**,**/.github/**,**/coverage/**,**/*.config.js,**/README.md,**/assets/**

            # FIX: Exclus√µes APENAS de Cobertura (Analisa bugs, mas n√£o pede teste)
            # Removemos App.js e index.js da conta de porcentagem
            -Dsonar.coverage.exclusions=**/node_modules/**,**/App.js,**/index.js,**/styles.js

            -Dsonar.test.exclusions=**/node_modules/**,**/.github/**
